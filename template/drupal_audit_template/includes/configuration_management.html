<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuration Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root {
      --droptica-primary: #0039FF;
      --droptica-success: #10B981;
      --droptica-warning: #F59E0B;
      --droptica-danger: #DC2626;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      padding: 20px;
    }

    h2 {
      color: var(--droptica-primary);
      border-bottom: 2px solid var(--droptica-primary);
      padding-bottom: 10px;
    }

    h3 {
      color: var(--droptica-primary);
      margin-top: 1.5rem;
    }

    .card {
      border: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .badge-status {
      padding: 0.35em 0.65em;
      font-size: 0.85em;
      font-weight: 500;
    }

    .module-icon {
      display: inline-block;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      text-align: center;
      line-height: 40px;
      font-size: 20px;
      margin-right: 12px;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--droptica-primary);
    }

    code {
      background-color: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <section class="card shadow-sm mb-4" id="config-management">
      <div class="card-body p-4">
        <h2 class="mb-4">Configuration Management Analysis</h2>
        <p>Comprehensive analysis of Drupal configuration sync system, management modules (Config Split, Config Ignore, Config Readonly), and best practices verification. Proper configuration management ensures consistent deployments, prevents config drift, and maintains production security.</p>

        <div id="config-management-content">
          <div class="text-center text-muted my-5">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Analyzing configuration management...</p>
          </div>
        </div>

      </div>
    </section>
  </div>

  <script>
    // Safe placeholder handling - will be replaced during audit generation
    let CONFIG_MANAGEMENT_DATA;
    try {
      CONFIG_MANAGEMENT_DATA = __CONFIGURATION_MANAGEMENT_JSON_PLACEHOLDER__;
    } catch (e) {
      // Placeholder not replaced yet - leave loading spinner visible
      CONFIG_MANAGEMENT_DATA = null;
    }

    function getModuleBadge(installed, status) {
      if (!installed) {
        return '<span class="badge bg-secondary badge-status"><i class="bi bi-x-circle me-1"></i>Not Installed</span>';
      }
      if (status === 'enabled' || status === 'Enabled') {
        return '<span class="badge bg-success badge-status"><i class="bi bi-check-circle me-1"></i>Enabled</span>';
      }
      return '<span class="badge bg-warning badge-status"><i class="bi bi-dash-circle me-1"></i>Disabled</span>';
    }

    function formatNumber(num) {
      return new Intl.NumberFormat().format(num);
    }

    function renderConfigManagement() {
      const container = document.getElementById('config-management-content');

      if (!CONFIG_MANAGEMENT_DATA || typeof CONFIG_MANAGEMENT_DATA !== 'object') {
        // Keep loading spinner if data is not available
        return;
      }

      const data = CONFIG_MANAGEMENT_DATA.full_analysis || {};
      let html = '';

      // Config Directory Status
      html += '<h3 class="mb-3"><i class="bi bi-folder me-2"></i>Configuration Directory</h3>';
      const configDir = data.config_directory || {};

      if (!configDir.exists) {
        html += '<div class="alert alert-danger border-start border-4 border-danger">';
        html += '<i class="bi bi-x-circle-fill me-2"></i>';
        html += '<strong>Configuration Directory Not Found</strong><br>';
        html += `Expected path: <code>${configDir.path || 'unknown'}</code><br>`;
        html += '<small>Configuration sync cannot work without a valid config directory. This is a critical setup issue.</small>';
        html += '</div>';
      } else {
        html += '<div class="alert alert-success border-start border-4 border-success">';
        html += '<i class="bi bi-check-circle-fill me-2"></i>';
        html += '<strong>Configuration Directory Found</strong><br>';
        html += `Path: <code>${configDir.path}</code> | `;
        html += `YAML files: <strong>${configDir.yml_files_count}</strong>`;
        html += '</div>';
      }

      // Sync Status
      html += '<h3 class="mb-3"><i class="bi bi-arrow-repeat me-2"></i>Configuration Sync Status</h3>';
      const syncStatus = data.sync_status || {};

      if (syncStatus.in_sync) {
        html += '<div class="alert alert-success border-start border-4 border-success">';
        html += '<i class="bi bi-check-circle-fill me-2"></i>';
        html += '<strong>Configuration is in sync</strong><br>';
        html += '<small>No differences detected between filesystem and database configuration.</small>';
        html += '</div>';
      } else {
        html += '<div class="alert alert-warning border-start border-4 border-warning">';
        html += '<i class="bi bi-exclamation-triangle-fill me-2"></i>';
        html += `<strong>Configuration is NOT in sync</strong> - ${syncStatus.differences_count || 0} differences found<br>`;
        html += '<small>Run <code>drush config:status</code> to see details, then <code>drush config:import</code> or <code>drush config:export</code></small>';
        html += '</div>';

        // Show differences table (limited to first 50)
        if (syncStatus.differences && syncStatus.differences.length > 0) {
          html += '<div class="card mb-3">';
          html += '<div class="card-body">';
          html += '<h6 class="card-title">Configuration Differences</h6>';
          html += '<div class="table-responsive">';
          html += '<table class="table table-sm table-hover">';
          html += '<thead class="table-light">';
          html += '<tr><th>Configuration Name</th><th>State</th></tr>';
          html += '</thead><tbody>';

          const diffsToShow = syncStatus.differences.slice(0, 50);
          diffsToShow.forEach(diff => {
            html += '<tr>';
            html += `<td><code class="small">${diff.name || diff}</code></td>`;
            html += `<td><span class="badge bg-warning badge-status">${diff.state || 'Different'}</span></td>`;
            html += '</tr>';
          });

          html += '</tbody></table>';
          html += '</div>';

          if (syncStatus.differences.length > 50) {
            html += `<p class="text-muted small mb-0">Showing first 50 of ${syncStatus.differences_count} differences</p>`;
          }
          html += '</div></div>';
        }
      }

      // Statistics
      html += '<h3 class="mb-3"><i class="bi bi-bar-chart me-2"></i>Statistics</h3>';
      const stats = data.statistics || {};
      html += '<div class="row mb-4">';

      html += '<div class="col-md-4 mb-3">';
      html += '<div class="card border-start border-4 border-primary">';
      html += '<div class="card-body">';
      html += '<h6 class="card-subtitle text-muted mb-2">Filesystem Configs</h6>';
      html += `<div class="stat-number">${formatNumber(stats.filesystem_configs || 0)}</div>`;
      html += '</div></div></div>';

      html += '<div class="col-md-4 mb-3">';
      html += '<div class="card border-start border-4 border-success">';
      html += '<div class="card-body">';
      html += '<h6 class="card-subtitle text-muted mb-2">Database Configs</h6>';
      html += `<div class="stat-number">${formatNumber(stats.database_configs || 0)}</div>`;
      html += '</div></div></div>';

      html += '<div class="col-md-4 mb-3">';
      const diffsBorderColor = (stats.differences || 0) > 0 ? 'border-warning' : 'border-success';
      html += `<div class="card border-start border-4 ${diffsBorderColor}">`;
      html += '<div class="card-body">';
      html += '<h6 class="card-subtitle text-muted mb-2">Differences</h6>';
      html += `<div class="stat-number">${formatNumber(stats.differences || 0)}</div>`;
      html += '</div></div></div>';

      html += '</div>';

      // Configuration Management Modules
      html += '<h3 class="mb-3"><i class="bi bi-plugin me-2"></i>Configuration Management Modules</h3>';
      const modules = data.modules || {};

      // Define all modules to check in a structured array
      const moduleDefinitions = [
        {
          key: 'config',
          name: 'Configuration Manager',
          icon: 'gear-fill',
          iconBg: 'primary',
          description: 'Core Drupal configuration system (required)',
          badge: { text: 'Core Module', type: 'primary' },
          getNotes: (mod) => mod.version || 'N/A'
        },
        {
          key: 'config_translation',
          name: 'Configuration Translation',
          icon: 'translate',
          iconBg: 'info',
          description: 'Translates configuration to other languages',
          badge: { text: 'Core Module', type: 'primary' },
          getNotes: (mod) => mod.version || 'N/A'
        },
        {
          key: 'config_update',
          name: 'Configuration Update Manager',
          icon: 'arrow-clockwise',
          iconBg: 'success',
          description: 'Provides tools for reviewing and updating configuration',
          badge: { text: 'Contrib Module', type: 'info' },
          getNotes: (mod) => mod.version || 'N/A'
        },
        {
          key: 'config_update_ui',
          name: 'Configuration Update UI',
          icon: 'grid',
          iconBg: 'success',
          description: 'User interface for Configuration Update Manager',
          badge: { text: 'Contrib Module', type: 'info' },
          getNotes: (mod) => mod.version || 'N/A'
        },
        {
          key: 'config_split',
          name: 'Config Split',
          icon: 'grid-3x3-gap',
          iconBg: 'primary',
          description: 'Allows environment-specific configuration (dev/staging/prod splits)',
          getNotes: (mod) => {
            if (mod.installed && mod.splits && mod.splits.length > 0) {
              return `<span class="badge bg-info badge-status">${mod.splits.length} split${mod.splits.length > 1 ? 's' : ''}</span>`;
            }
            return '';
          }
        },
        {
          key: 'config_ignore',
          name: 'Config Ignore',
          icon: 'eye-slash',
          iconBg: 'warning',
          description: 'Excludes specific configuration from sync operations',
          getNotes: (mod) => {
            if (mod.installed && mod.ignored_configs && mod.ignored_configs.length > 0) {
              return `<span class="badge bg-info badge-status">${mod.ignored_configs.length} pattern${mod.ignored_configs.length > 1 ? 's' : ''}</span>`;
            }
            return '';
          }
        },
        {
          key: 'config_readonly',
          name: 'Config Readonly',
          icon: 'lock',
          iconBg: 'danger',
          description: 'Prevents configuration changes via web UI',
          badge: { text: 'Recommended for production', type: 'success' },
          getNotes: (mod) => {
            if (mod.installed && mod.locked) {
              return '<span class="badge bg-success badge-status"><i class="bi bi-lock-fill"></i> Locked</span>';
            } else if (mod.installed && !mod.locked) {
              return '<span class="badge bg-warning badge-status"><i class="bi bi-unlock-fill"></i> Not locked</span>';
            }
            return '';
          }
        },
        {
          key: 'config_filter',
          name: 'Config Filter',
          icon: 'funnel',
          iconBg: 'info',
          description: 'Provides API for filtering configuration during import/export (usually installed as dependency)',
          getNotes: () => ''
        },
        {
          key: 'config_devel',
          name: 'Config Devel',
          icon: 'code-square',
          iconBg: 'secondary',
          description: 'Development tool for writing config to disk',
          badge: { text: 'NEVER use in production!', type: 'danger' },
          enabledIconDanger: true,
          getNotes: (mod) => {
            if (mod.warning && (mod.status === 'enabled' || mod.status === 'Enabled')) {
              return '<span class="badge bg-danger badge-status"><i class="bi bi-exclamation-triangle-fill"></i> WARNING</span>';
            }
            return '';
          }
        },
        {
          key: 'features',
          name: 'Features',
          icon: 'box-seam',
          iconBg: 'warning',
          description: 'Legacy module from Drupal 7',
          badge: { text: 'Use for packaging only, NOT config deployment', type: 'warning' },
          enabledIconWarning: true,
          getNotes: (mod) => {
            let notes = '';
            if (mod.installed && mod.features_count > 0) {
              notes += `<span class="badge bg-info badge-status">${mod.features_count} feature${mod.features_count > 1 ? 's' : ''}</span>`;
            }
            if (mod.warning) {
              notes += '<br><span class="badge bg-warning badge-status mt-1"><i class="bi bi-exclamation-triangle-fill"></i> Check usage</span>';
            }
            return notes;
          }
        },
        {
          key: 'config_sync',
          name: 'Configuration Synchronizer',
          icon: 'arrow-repeat',
          iconBg: 'success',
          description: 'Extends core config management with additional sync capabilities',
          getNotes: () => ''
        }
      ];

      html += '<div class="card mb-3">';
      html += '<div class="card-body">';
      html += '<div class="table-responsive">';
      html += '<table class="table table-hover align-middle">';
      html += '<thead class="table-light">';
      html += '<tr>';
      html += '<th style="width: 25%;">Module</th>';
      html += '<th style="width: 35%;">Description</th>';
      html += '<th style="width: 15%;" class="text-center">In Codebase/<br>Composer</th>';
      html += '<th style="width: 15%;" class="text-center">Enabled in<br>Drupal</th>';
      html += '<th style="width: 10%;">Notes</th>';
      html += '</tr>';
      html += '</thead><tbody>';

      // Loop through all module definitions
      moduleDefinitions.forEach(def => {
        const mod = modules[def.key] || {};
        const isEnabled = mod.installed && (mod.status === 'enabled' || mod.status === 'Enabled');

        html += '<tr>';

        // Module name column
        html += '<td>';
        html += `<span class="module-icon bg-${def.iconBg} bg-opacity-10 text-${def.iconBg} me-2"><i class="bi bi-${def.icon}"></i></span>`;
        html += `<strong>${def.name}</strong><br><small class="text-muted">${def.key}</small>`;
        html += '</td>';

        // Description column
        html += '<td><small>';
        html += def.description;
        if (def.badge) {
          html += `<br><span class="badge bg-${def.badge.type} badge-status mt-1">${def.badge.text}</span>`;
        }
        html += '</small></td>';

        // In codebase column
        html += '<td class="text-center">';
        html += mod.installed
          ? '<i class="bi bi-check-circle-fill text-success fs-5"></i>'
          : '<i class="bi bi-x-circle-fill text-danger fs-5"></i>';
        html += '</td>';

        // Enabled in Drupal column
        html += '<td class="text-center">';
        if (isEnabled) {
          const iconColor = def.enabledIconDanger ? 'danger' : (def.enabledIconWarning ? 'warning' : 'success');
          html += `<i class="bi bi-check-circle-fill text-${iconColor} fs-5"></i>`;
        } else {
          html += '<i class="bi bi-x-circle-fill text-secondary fs-5"></i>';
        }
        html += '</td>';

        // Notes column
        html += '<td>';
        html += def.getNotes(mod);
        html += '</td>';

        html += '</tr>';
      });

      html += '</tbody></table>';
      html += '</div>';
      html += '</div></div>';

      // Additional details for Config Split (if has splits configured)
      const configSplit = modules.config_split || {};
      if (configSplit.installed && configSplit.splits && configSplit.splits.length > 0) {
        html += '<div class="card mb-3">';
        html += '<div class="card-body">';
        html += '<h6 class="mb-3"><i class="bi bi-grid-3x3-gap me-2"></i>Config Split - Configured Splits</h6>';
        html += '<div class="table-responsive">';
        html += '<table class="table table-sm table-hover">';
        html += '<thead class="table-light">';
        html += '<tr><th>Split Name</th><th>ID</th><th>Status</th><th>Folder</th></tr>';
        html += '</thead><tbody>';
        configSplit.splits.forEach(split => {
          html += '<tr>';
          html += `<td><strong>${split.label}</strong></td>`;
          html += `<td><code>${split.id}</code></td>`;
          html += `<td>${split.status ? '<span class="badge bg-success badge-status">Active</span>' : '<span class="badge bg-secondary badge-status">Inactive</span>'}</td>`;
          html += `<td><code>${split.folder || 'Not set'}</code></td>`;
          html += '</tr>';
        });
        html += '</tbody></table>';
        html += '</div>';
        html += '</div></div>';
      }

      // Additional details for Config Ignore (if has patterns)
      const configIgnore = modules.config_ignore || {};
      if (configIgnore.installed && configIgnore.ignored_configs && configIgnore.ignored_configs.length > 0) {
        html += '<div class="card mb-3">';
        html += '<div class="card-body">';
        html += '<h6 class="mb-3"><i class="bi bi-eye-slash me-2"></i>Config Ignore - Ignored Configuration Patterns</h6>';
        html += '<div class="bg-light p-3 rounded">';
        configIgnore.ignored_configs.forEach(pattern => {
          html += `<code class="d-block mb-1">${pattern}</code>`;
        });
        html += '</div>';
        html += '</div></div>';
      }

      // Additional details for Features (if has warning)
      const features = modules.features || {};
      if (features.installed && features.warning) {
        html += '<div class="card mb-3 border-warning">';
        html += '<div class="card-body">';
        html += '<h6 class="mb-3"><i class="bi bi-box-seam me-2"></i>Features Module - Usage Notice</h6>';
        html += '<div class="alert alert-warning border-start border-4 border-warning mb-0">';
        html += '<i class="bi bi-exclamation-triangle-fill me-2"></i>';
        html += '<strong>Important:</strong> Features module is installed and enabled. ';
        html += 'In Drupal 8+, Features should <strong>only</strong> be used for packaging reusable functionality (like custom modules with default config), ';
        html += '<strong>NOT</strong> for deploying configuration changes between environments. ';
        html += 'Use core configuration management (<code>drush config-export</code> and <code>drush config-import</code>) for config deployment.';
        if (features.features_count > 0) {
          html += `<br><br>Found <strong>${features.features_count}</strong> feature${features.features_count > 1 ? 's' : ''} configured. Review their purpose to ensure they follow best practices.`;
        }
        html += '</div>';
        html += '</div></div>';
      }


      // Recommendations
      html += '<h3 class="mb-3 mt-4"><i class="bi bi-lightbulb me-2"></i>Recommendations</h3>';
      const recommendations = [];

      // Get module references for recommendations
      const configReadonly = modules.config_readonly || {};
      const configDevel = modules.config_devel || {};
      const configSplitRec = modules.config_split || {};
      const featuresRec = modules.features || {};

      if (!configDir.exists) {
        recommendations.push({
          type: 'danger',
          title: 'Configure Config Sync Directory',
          text: 'Set up a configuration sync directory to enable proper config management. Add to <code>settings.php</code>: <code>$settings[\'config_sync_directory\'] = \'../config/sync\';</code>'
        });
      }

      if (syncStatus && !syncStatus.in_sync && syncStatus.differences_count > 0) {
        recommendations.push({
          type: 'warning',
          title: 'Sync Configuration',
          text: `You have ${syncStatus.differences_count} configuration differences. Run: <code>drush config:import</code> or <code>drush config:export</code>`
        });
      }

      if (!configReadonly.installed) {
        recommendations.push({
          type: 'info',
          title: 'Install Config Readonly for Production',
          text: 'Consider installing Config Readonly module to prevent unauthorized config changes in production: <code>composer require drupal/config_readonly</code>'
        });
      } else if (configReadonly.installed && !configReadonly.locked) {
        recommendations.push({
          type: 'warning',
          title: 'Enable Config Readonly Lock',
          text: 'Config Readonly is installed but not locked. Enable locking in production environments.'
        });
      }

      if (configDevel.warning) {
        recommendations.push({
          type: 'danger',
          title: 'Disable Config Devel in Production',
          text: 'Config Devel is a development-only module and should NEVER be enabled in production. Run: <code>drush pm:uninstall config_devel</code>'
        });
      }

      if (featuresRec.installed && featuresRec.warning) {
        recommendations.push({
          type: 'warning',
          title: 'Review Features Module Usage',
          text: 'Features module is enabled. In Drupal 8+, Features should ONLY be used for packaging reusable functionality, NOT for configuration deployment. Use core configuration management (drush config-export/import) for config deployment instead.'
        });
      }

      if (!configSplitRec.installed) {
        recommendations.push({
          type: 'info',
          title: 'Consider Config Split for Multi-Environment Setup',
          text: 'If you have multiple environments (dev/staging/prod), Config Split helps manage environment-specific configuration: <code>composer require drupal/config_split</code>'
        });
      }

      if (recommendations.length === 0) {
        html += '<div class="alert alert-success border-start border-4 border-success">';
        html += '<i class="bi bi-check-circle-fill me-2"></i>';
        html += '<strong>Configuration management looks good!</strong><br>';
        html += '<small>No critical issues detected. Your configuration management setup follows best practices.</small>';
        html += '</div>';
      } else {
        recommendations.forEach(rec => {
          const iconMap = {
            danger: 'exclamation-triangle-fill',
            warning: 'exclamation-circle-fill',
            info: 'info-circle-fill'
          };
          html += `<div class="alert alert-${rec.type} border-start border-4 border-${rec.type}">`;
          html += `<i class="bi bi-${iconMap[rec.type]} me-2"></i>`;
          html += `<strong>${rec.title}</strong><br>`;
          html += `<small>${rec.text}</small>`;
          html += '</div>';
        });
      }

      container.innerHTML = html;
    }

    // Render when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', renderConfigManagement);
    } else {
      renderConfigManagement();
    }
  </script>
</body>
</html>
