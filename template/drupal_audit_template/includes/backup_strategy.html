<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backup Strategy Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root {
      --droptica-primary: #0039FF;
      --droptica-success: #10B981;
      --droptica-warning: #F59E0B;
      --droptica-danger: #DC2626;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      padding: 20px;
    }

    h2 {
      color: var(--droptica-primary);
      border-bottom: 2px solid var(--droptica-primary);
      padding-bottom: 10px;
    }

    h3 {
      color: var(--droptica-primary);
      margin-top: 1.5rem;
    }

    .card {
      border: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .section-intro {
      background: rgba(0, 57, 255, 0.05);
      padding: 15px;
      border-left: 4px solid var(--droptica-primary);
      margin: 20px 0;
      border-radius: 4px;
    }

    .error-message {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid var(--droptica-warning);
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }

    .error-message h3 {
      color: var(--droptica-warning);
      margin-top: 0;
    }

    .error-message code {
      background: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }

    .score-card {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .score-item {
      background: var(--droptica-primary);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .score-item.pass {
      background: var(--droptica-success);
    }

    .score-item.warning {
      background: var(--droptica-warning);
    }

    .score-item.fail {
      background: var(--droptica-danger);
    }

    .score-item.critical {
      background: var(--droptica-danger);
    }

    .score-value {
      font-size: 2.5em;
      font-weight: bold;
      margin: 10px 0;
    }

    .score-label {
      font-size: 0.9em;
      opacity: 0.9;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    thead {
      background: var(--droptica-primary);
      color: white;
    }

    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #ecf0f1;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .issue-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 15px;
      margin: 15px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .issue-card.error {
      border-left: 4px solid var(--droptica-danger);
    }

    .issue-card.warning {
      border-left: 4px solid var(--droptica-warning);
    }

    .issue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .issue-code {
      background: #ecf0f1;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .issue-type {
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: bold;
      text-transform: uppercase;
    }

    .issue-type.error {
      background: var(--droptica-danger);
      color: white;
    }

    .issue-type.warning {
      background: var(--droptica-warning);
      color: white;
    }

    .issue-message {
      color: #555;
      margin: 10px 0;
    }

    .issue-context {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .issue-selector {
      color: #7f8c8d;
      font-size: 0.9em;
      margin-top: 8px;
      font-family: 'Courier New', monospace;
    }

    .principle-card {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 15px;
      margin: 10px 0;
    }

    .principle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .principle-name {
      font-weight: bold;
      color: #2c3e50;
    }

    .principle-count {
      background: var(--droptica-primary);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.9em;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: bold;
      margin: 0 5px;
    }

    .badge.success {
      background: var(--droptica-success);
      color: white;
    }

    .badge.warning {
      background: var(--droptica-warning);
      color: white;
    }

    .badge.danger {
      background: var(--droptica-danger);
      color: white;
    }

    .info-box {
      background: rgba(0, 57, 255, 0.05);
      border-left: 4px solid var(--droptica-primary);
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }

    .info-box strong {
      color: var(--droptica-primary);
    }

    code {
      background: #ecf0f1;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .no-issues {
      text-align: center;
      padding: 40px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 6px;
      color: #10B981;
      font-size: 1.1em;
    }

    @media (max-width: 768px) {
      .score-card {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 0.9em;
      }

      .issue-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <section class="card shadow-sm mb-4">
      <div class="card-body p-4">
    <div class="container">
        <h2 class="mb-4"><i class="bi bi-hdd-stack"></i> Backup Strategy Analysis</h2>

        <div class="section-intro">
            <strong>About This Section:</strong> This analysis examines backup configuration, modules, scripts, and disaster recovery preparedness. It evaluates automated backup solutions, storage locations, and backup procedures to ensure data safety.
        </div>

        <div class="server-warning">
            <h3> Important Note About Server-Side Backups</h3>
            <p><strong>This analysis is limited to codebase-level backup detection.</strong></p>
            <p>Many production environments use server-side backup scripts, cron jobs, and hosting provider backup solutions that are <strong>not visible</strong> in the Drupal codebase.</p>
            <p><strong>Recommended Actions:</strong></p>
            <ul>
                <li>Check server <code>crontab -l</code> for scheduled backup jobs</li>
                <li>Review hosting provider backup policies and retention</li>
                <li>Verify offsite backup storage configuration</li>
                <li>Test backup restoration procedures regularly</li>
                <li>Document backup and recovery procedures in team documentation</li>
            </ul>
        </div>

        <div id="loading" class="text-center text-muted my-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading backup strategy data...</span>
            </div>
            <p class="mt-2">Loading backup strategy data...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Summary -->
            <h2> Backup Strategy Summary</h2>
            <div id="summary-section">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Statistics -->
            <div class="stats-grid" id="stats-grid">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Backup and Migrate Module -->
            <h2> Backup and Migrate Module</h2>
            <div id="backup-migrate-section">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Custom Scripts -->
            <h2> Custom Backup Scripts</h2>
            <div id="scripts-section">
                <!-- Populated by JavaScript -->
            </div>

            <!-- DDEV Snapshots -->
            <h2> DDEV Snapshots</h2>
            <div id="ddev-section">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Private File Path -->
            <h2>üîí Private File Path Configuration</h2>
            <div id="private-path-section">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Composer Scripts -->
            <h2> Composer Backup Scripts</h2>
            <div id="composer-section">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Other Modules -->
            <h2>üîå Other Backup-Related Modules</h2>
            <div id="other-modules-section">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Documentation -->
            <h2>üìö Documentation with Backup Info</h2>
            <div id="documentation-section">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Database Backup -->
            <h2>üóÑ Database Backup Command</h2>
            <div id="database-section">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Recommendations -->
            <h2>üí° Recommendations</h2>
            <div id="recommendations-section">
                <!-- Populated by JavaScript -->
            </div>
        </div>

    </div>

    <script>
        // Safe placeholder handling
        let BACKUP_STRATEGY_DATA;
        try {
            BACKUP_STRATEGY_DATA = __BACKUP_STRATEGY_JSON_PLACEHOLDER__;
        } catch (e) {
            BACKUP_STRATEGY_DATA = null;
        }

        function renderBackupStrategy() {
            if (!BACKUP_STRATEGY_DATA) {
                // Keep loading spinner if data is not available
                return;
            }
            
            // Hide spinner
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // Extract data from nested structure
            const data = BACKUP_STRATEGY_DATA.backup_strategy || BACKUP_STRATEGY_DATA;
            const fullAnalysis = data.full_analysis || data;

            renderBackupAnalysis(fullAnalysis);
        }

        function renderBackupAnalysis(data) {
            // Summary
            const summary = data.summary || {};
            const level = summary.backup_strategy_level || 'none';
            let strategyClass = 'strategy-' + level;
            let strategyEmoji = level === 'advanced' ? '‚úÖ' : level === 'basic' ? '' : '‚ùå';

            document.getElementById('summary-section').innerHTML = `
                <div style="margin: 15px 0;">
                    <span class="strategy-badge ${strategyClass}">${strategyEmoji} ${level.toUpperCase()} Backup Strategy</span>
                </div>
                <p style="margin: 15px 0;">
                    <strong>Strategy Level:</strong> ${level.charAt(0).toUpperCase() + level.slice(1)}<br>
                    <strong>Description:</strong> ${
                        level === 'advanced' ? 'Multiple backup methods detected. Good disaster recovery preparedness.' :
                        level === 'basic' ? 'Basic backup solution in place. Consider additional backup methods.' :
                        'No automated backup solution detected in codebase. Server-side analysis required.'
                    }
                </p>
            `;

            // Statistics
            const scriptsCount = summary.custom_scripts_found || 0;
            const docsCount = summary.documentation_found || 0;
            const backupMigrate = data.backup_migrate_module || {};
            const ddev = data.ddev_snapshots || {};

            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-card">
                    <h3>Custom Scripts</h3>
                    <div class="value">${scriptsCount}</div>
                    <div class="label">Found</div>
                </div>
                <div class="stat-card">
                    <h3>Documentation</h3>
                    <div class="value">${docsCount}</div>
                    <div class="label">Files Found</div>
                </div>
                <div class="stat-card">
                    <h3>DDEV Snapshots</h3>
                    <div class="value">${ddev.snapshots_count || 0}</div>
                    <div class="label">Available</div>
                </div>
                <div class="stat-card">
                    <h3>Module Status</h3>
                    <div class="value">${backupMigrate.status === 'enabled' ? '‚úì' : '‚úó'}</div>
                    <div class="label">Backup & Migrate</div>
                </div>
            `;

            // Backup and Migrate Module
            let backupMigrateHtml = '';
            if (backupMigrate.status === 'not_installed') {
                backupMigrateHtml = '<div class="warning-box"><strong>Not Installed:</strong> Backup and Migrate module is not installed.</div>';
            } else if (backupMigrate.status === 'enabled') {
                backupMigrateHtml = `
                    <div class="success-box">
                        <strong>‚úÖ Enabled</strong> - Version: ${backupMigrate.version || 'unknown'}
                    </div>
                    <h3>Configuration Summary</h3>
                    <div class="config-item">
                        <span class="config-label">Destinations Configured:</span> ${backupMigrate.destinations_count || 0}
                    </div>
                    <div class="config-item">
                        <span class="config-label">Schedules Configured:</span> ${backupMigrate.schedules_count || 0}
                    </div>
                `;

                // Display main config if available
                if (backupMigrate.main_config && Object.keys(backupMigrate.main_config).length > 0) {
                    backupMigrateHtml += '<h3>Main Configuration Settings</h3>';
                    backupMigrateHtml += '<table><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody>';
                    for (const [key, value] of Object.entries(backupMigrate.main_config)) {
                        const displayValue = typeof value === 'object' ? JSON.stringify(value, null, 2) : value;
                        backupMigrateHtml += `
                            <tr>
                                <td><code>${key}</code></td>
                                <td>${displayValue}</td>
                            </tr>
                        `;
                    }
                    backupMigrateHtml += '</tbody></table>';
                }

                if (backupMigrate.config_objects && backupMigrate.config_objects.length > 0) {
                    backupMigrateHtml += '<h3>All Configuration Objects</h3>';
                    backupMigrateHtml += '<div class="info-box">The following configuration objects are defined for this module:</div>';
                    backupMigrateHtml += '<ul>';
                    backupMigrate.config_objects.forEach(obj => {
                        if (obj) backupMigrateHtml += `<li><code>${obj}</code></li>`;
                    });
                    backupMigrateHtml += '</ul>';
                }
            } else {
                backupMigrateHtml = `
                    <div class="info-box">
                        <strong>Installed but Not Enabled:</strong> Version: ${backupMigrate.version || 'unknown'}<br>
                        Consider enabling the module for automated backups.
                    </div>
                `;
            }
            document.getElementById('backup-migrate-section').innerHTML = backupMigrateHtml;

            // Custom Scripts
            const scripts = data.custom_backup_scripts || [];
            let scriptsHtml = '';
            if (scripts.length === 0) {
                scriptsHtml = '<div class="info-box">No custom backup scripts found in project root, /scripts, or .ddev directories.</div>';
            } else {
                scriptsHtml = `<div class="success-box"><strong>Found ${scripts.length} custom backup script(s)</strong></div>`;
                scripts.forEach(script => {
                    scriptsHtml += `<div class="script-item">${script}</div>`;
                });
            }
            document.getElementById('scripts-section').innerHTML = scriptsHtml;

            // DDEV Snapshots
            let ddevHtml = '';
            if (ddev.snapshots_directory_exists) {
                ddevHtml = `
                    <div class="success-box">
                        <strong>‚úÖ DDEV Snapshots Available</strong><br>
                        Snapshots found: ${ddev.snapshots_count || 0}
                    </div>
                    <p>${ddev.note || ''}</p>
                    <h3>Available Commands</h3>
                    <ul>
                        ${(ddev.ddev_commands || []).map(cmd => `<li><code>${cmd}</code></li>`).join('')}
                    </ul>
                `;
            } else {
                ddevHtml = '<div class="info-box">DDEV environment detected but no snapshots directory found.</div>';
            }
            document.getElementById('ddev-section').innerHTML = ddevHtml;

            // Private File Path
            const privatePath = data.private_file_path || {};
            let privatePathHtml = '';
            if (privatePath.configured) {
                privatePathHtml = `
                    <div class="success-box">
                        <strong>‚úÖ Configured</strong><br>
                        Path: <code>${privatePath.private_file_path}</code>
                    </div>
                    <p>${privatePath.note || ''}</p>
                `;
            } else {
                privatePathHtml = `
                    <div class="warning-box">
                        <strong> Not Configured</strong><br>
                        ${privatePath.note || 'Private file path is not configured.'}
                    </div>
                `;
            }
            document.getElementById('private-path-section').innerHTML = privatePathHtml;

            // Composer Scripts
            const composer = data.composer_scripts || {};
            let composerHtml = '';
            if (composer.backup_scripts && composer.backup_scripts.length > 0) {
                composerHtml = '<div class="success-box"><strong>Found backup-related scripts in composer.json</strong></div><ul>';
                composer.backup_scripts.forEach(script => {
                    composerHtml += `<li><code>${script}</code></li>`;
                });
                composerHtml += '</ul>';
            } else {
                composerHtml = '<div class="info-box">' + (composer.note || 'No backup-related scripts found in composer.json') + '</div>';
            }
            document.getElementById('composer-section').innerHTML = composerHtml;

            // Other Modules
            const otherModules = data.other_backup_modules || {};
            let otherModulesHtml = '<table><thead><tr><th>Module</th><th>Status</th></tr></thead><tbody>';
            let hasEnabledModules = false;

            Object.keys(otherModules).forEach(module => {
                const status = otherModules[module];
                const badge = status === 'enabled' ? 'badge-success' : status === 'disabled' ? 'badge-warning' : 'badge-info';
                otherModulesHtml += `
                    <tr>
                        <td><code>${module}</code></td>
                        <td><span class="badge ${badge}">${status}</span></td>
                    </tr>
                `;
                if (status === 'enabled') hasEnabledModules = true;
            });
            otherModulesHtml += '</tbody></table>';

            if (!hasEnabledModules) {
                otherModulesHtml += '<div class="info-box">No other backup-related modules are currently enabled.</div>';
            }

            document.getElementById('other-modules-section').innerHTML = otherModulesHtml;

            // Documentation
            const docs = data.documentation_with_backup_info || [];
            let docsHtml = '';
            if (docs.length === 0) {
                docsHtml = '<div class="warning-box">No documentation files with backup information found.</div>';
            } else {
                docsHtml = '<div class="success-box"><strong>Found documentation mentioning backup procedures</strong></div><ul>';
                docs.forEach(doc => {
                    docsHtml += `<li><code>${doc}</code></li>`;
                });
                docsHtml += '</ul>';
            }
            document.getElementById('documentation-section').innerHTML = docsHtml;

            // Database Backup
            const dbBackup = data.database_backup_command || {};
            let dbHtml = '';
            if (dbBackup.drush_sql_dump === 'available') {
                dbHtml = `
                    <div class="success-box">
                        <strong>‚úÖ Available:</strong> <code>drush sql-dump</code> command is available for database backups.
                    </div>
                    <p>${dbBackup.note || ''}</p>
                    <h3>Example Usage</h3>
                    <div class="script-item">
                        # Export database to file<br>
                        doc drush sql-dump > backup.sql<br>
                        <br>
                        # Export with gzip compression<br>
                        doc drush sql-dump | gzip > backup.sql.gz
                    </div>
                `;
            } else {
                dbHtml = '<div class="error-box"><strong>‚ùå Not Available:</strong> Drush sql-dump command is not available.</div>';
            }
            document.getElementById('database-section').innerHTML = dbHtml;

            // Recommendations
            const recommendations = summary.recommendations || [];
            let recsHtml = '';

            if (recommendations.length === 0) {
                recsHtml = '<div class="success-box"><strong>Great!</strong> No major recommendations. Your backup strategy appears adequate.</div>';
            } else {
                recommendations.forEach(rec => {
                    recsHtml += `<div class="recommendation-item"> ${rec}</div>`;
                });
            }

            document.getElementById('recommendations-section').innerHTML = recsHtml;
        }
        
        // Call render function
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', renderBackupStrategy);
        } else {
            renderBackupStrategy();
        }
    
    </script>
      </div>
    </section>
  </div>
</body>
